<?xml version="1.0" encoding="UTF-8"?>
<Stage1Report locale="ja-JP" version="1.1">
  <Summary>
    <Purpose>WSL上でDirectML対応PyTorchを稼働させる基盤整備。</Purpose>
    <Date>2024-12-08</Date>
    <Environment>Windows 11 Pro + WSL2 Ubuntu 24.04 / Ryzen AI Max+ 395 / Radeon 8060S / DirectML</Environment>
  </Summary>
  <Checklist>
    <Item id="C1">
      <Task>Windows側でWSLをインストールしGPUパススルーを確認する。</Task>
      <SuccessCriteria>PowerShellで `wsl --install -d Ubuntu-24.04` を実行済みで、`wsl -l -v` でUbuntuがRunning。</SuccessCriteria>
      <FailureModes>旧版Windows/WSLでGPUが認識しない。修正: Windows Update→再起動→`wsl --update`。</FailureModes>
    </Item>
    <Item id="C2">
      <Task>WSLカーネル更新および基本パッケージを整備する。</Task>
      <SuccessCriteria>`uname -r` が最新Kernel、`sudo apt update` `sudo apt install` が成功。</SuccessCriteria>
      <FailureModes>APTミラー不調→`sudo sed -i`でミラー変更、再実行。</FailureModes>
    </Item>
    <Item id="C3">
      <Task>DirectML対応PyTorch仮想環境を構築する。</Task>
      <SuccessCriteria>`python3 -m venv /opt/ai/venvs/directml` 作成後、`pip install torch-directml` が成功。</SuccessCriteria>
      <FailureModes>DirectMLモジュールがロード不可→`pip install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu121` を追加。</FailureModes>
    </Item>
    <Item id="C4">
      <Task>torch-directmlデバイス検証スクリプトを実行しログを保存する。</Task>
      <SuccessCriteria>`torch_directml_check.log` に `directml.device:` 行が出力。</SuccessCriteria>
      <FailureModes>DirectMLデバイスがCPUフォールバック→Windows側のDirectML Runtime更新を実施。</FailureModes>
    </Item>
  </Checklist>
  <KnownPitfalls>
    <Pitfall>
      <Issue>WSLカーネルが古くDirectMLバックエンドが利用できない。</Issue>
      <Resolution>`wsl --update` → Windows再起動 → `wsl --shutdown` 後に再試行。</Resolution>
    </Pitfall>
    <Pitfall>
      <Issue>torch-directmlとCUDAホイールの互換性。</Issue>
      <Resolution>torch-directmlはCPU経由で動作するため、GPU利用時はDirectML Runtimeを最新版にする。</Resolution>
    </Pitfall>
    <Pitfall>
      <Issue>Windows側のGPUドライバが古くDirectML機能が制限。</Issue>
      <Resolution>AMD Adrenalinドライバを更新し、DirectMLサポート有無を確認。</Resolution>
    </Pitfall>
  </KnownPitfalls>
  <Logs>
    <LogFile path="logs/phase1/torch_device_check_example.log" description="torch-directml検証ログ例" />
    <LogFile path="/opt/ai/logs/phase1/wsl_directml_setup_YYYYMMDD_HHMMSS.log" description="実行時のチェックリスト出力" />
  </Logs>
  <MCPPlans>
    <Serena task="Stage1 ChecklistのDAG化" outcome="成功条件と回復手順をTODO化" />
    <Cipher task="DirectML/torchバージョン固定レビュー" outcome="SBOM案とハッシュ検証提案" />
    <Zen task="DirectMLテスト失敗時フロー" outcome="Windows/WSL/Runtime別If-Thenフロー" />
  </MCPPlans>
</Stage1Report>
